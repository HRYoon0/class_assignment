<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ˆë“±í•™êµ ë°˜í¸ì„± í”„ë¡œê·¸ë¨</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Jua', sans-serif;
        }

        body {
            font-family: 'Jua', sans-serif;
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 50%, #FCE4EC 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(156, 136, 255, 0.15);
            padding: 40px;
            backdrop-filter: blur(10px);
        }

        h1 {
            background: linear-gradient(135deg, #B39DDB 0%, #CE93D8 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 800;
        }

        .subtitle {
            text-align: center;
            color: #9C88AA;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .control-panel {
            background: linear-gradient(135deg, #F8F4FF 0%, #FFF8F8 100%);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            border: 2px solid rgba(206, 147, 216, 0.2);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: bold;
            color: #8E7A99;
            font-size: 0.95em;
        }

        input[type="file"],
        input[type="number"],
        input[type="text"] {
            padding: 10px 15px;
            border: 2px solid #E8D5F0;
            border-radius: 12px;
            font-size: 1em;
            transition: all 0.3s;
            background: white;
        }

        input[type="file"]:hover,
        input[type="number"]:hover,
        input[type="text"]:hover {
            border-color: #CE93D8;
            box-shadow: 0 2px 10px rgba(206, 147, 216, 0.15);
        }

        input[type="file"]:focus,
        input[type="number"]:focus,
        input[type="text"]:focus {
            outline: none;
            border-color: #B39DDB;
            box-shadow: 0 2px 15px rgba(179, 157, 219, 0.25);
        }

        button {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .btn-primary {
            background: linear-gradient(135deg, #B39DDB 0%, #CE93D8 100%);
            box-shadow: 0 4px 15px rgba(179, 157, 219, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(179, 157, 219, 0.4);
            background: linear-gradient(135deg, #9C88C4 0%, #BA81C5 100%);
        }

        .btn-success {
            background: linear-gradient(135deg, #A5D6A7 0%, #81C784 100%);
            box-shadow: 0 4px 15px rgba(129, 199, 132, 0.3);
        }

        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(129, 199, 132, 0.4);
            background: linear-gradient(135deg, #90C695 0%, #66BB6A 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #F8BBD0 0%, #F48FB1 100%);
            padding: 8px 16px;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(244, 143, 177, 0.3);
        }

        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(244, 143, 177, 0.4);
            background: linear-gradient(135deg, #F5A9C3 0%, #EC407A 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%);
            padding: 8px 16px;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(206, 147, 216, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(206, 147, 216, 0.4);
        }

        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: linear-gradient(135deg, #B39DDB 0%, #CE93D8 100%);
            color: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(179, 157, 219, 0.25);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 35px rgba(179, 157, 219, 0.35);
        }

        .stat-card:nth-child(1) {
            background: linear-gradient(135deg, #B39DDB 0%, #9575CD 100%);
        }

        .stat-card:nth-child(2) {
            background: linear-gradient(135deg, #90CAF9 0%, #64B5F6 100%);
        }

        .stat-card:nth-child(3) {
            background: linear-gradient(135deg, #A5D6A7 0%, #81C784 100%);
        }

        .stat-card h3 {
            font-size: 0.9em;
            opacity: 0.95;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-card .number {
            font-size: 2.2em;
            font-weight: bold;
        }

        .table-container {
            overflow-x: auto;
            margin-bottom: 25px;
            border-radius: 20px;
            border: 2px solid #E8D5F0;
            box-shadow: 0 4px 15px rgba(206, 147, 216, 0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background: linear-gradient(135deg, #E1BEE7 0%, #CE93D8 100%);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px;
            text-align: center;
            border-bottom: 1px solid #F3E5F5;
        }

        tbody tr:hover {
            background: linear-gradient(135deg, #F8F4FF 0%, #FFF8F8 100%);
        }

        td input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #E8D5F0;
            border-radius: 8px;
            text-align: center;
            transition: border-color 0.3s;
        }

        td input:focus {
            outline: none;
            border-color: #CE93D8;
        }

        .action-buttons {
            display: flex;
            gap: 5px;
            justify-content: center;
        }

        .add-row-section {
            background: linear-gradient(135deg, #FFF8F8 0%, #F8F4FF 100%);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border: 2px solid rgba(206, 147, 216, 0.2);
        }

        .add-row-section h3 {
            color: #B39DDB;
        }

        .add-row-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }

        .result-section {
            margin-top: 30px;
            padding: 30px;
            background: linear-gradient(135deg, #F3E5F5 0%, #FCE4EC 100%);
            border-radius: 25px;
            display: none;
            border: 2px solid rgba(206, 147, 216, 0.2);
        }

        .result-section.show {
            display: block;
        }

        .result-section h2 {
            color: #B39DDB;
        }

        .class-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .class-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(179, 157, 219, 0.15);
            border: 2px solid rgba(206, 147, 216, 0.1);
            transition: transform 0.3s;
        }

        .class-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(179, 157, 219, 0.25);
        }

        .class-card h3 {
            color: #B39DDB;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 3px solid #E1BEE7;
        }

        .class-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
            padding: 15px;
            background: linear-gradient(135deg, #F8F4FF 0%, #FFF8F8 100%);
            border-radius: 12px;
        }

        .class-stats div {
            font-size: 0.9em;
            color: #6D5D7A;
        }

        .class-stats strong {
            color: #B39DDB;
        }

        .student-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .student-list::-webkit-scrollbar {
            width: 8px;
        }

        .student-list::-webkit-scrollbar-track {
            background: #F3E5F5;
            border-radius: 10px;
        }

        .student-list::-webkit-scrollbar-thumb {
            background: #CE93D8;
            border-radius: 10px;
        }

        .student-item {
            padding: 10px;
            border-bottom: 1px solid #F3E5F5;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .student-item:hover {
            background: #F8F4FF;
        }

        .student-item:last-child {
            border-bottom: none;
        }

        .student-name {
            font-weight: bold;
            color: #6D5D7A;
        }

        .student-score {
            color: #9C88AA;
            font-size: 0.9em;
        }

        .student-note {
            color: #F48FB1;
            font-size: 0.85em;
            margin-left: 10px;
        }

        .alert {
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: bold;
        }

        .alert-success {
            background: #C8E6C9;
            color: #2E7D32;
            border: 2px solid #A5D6A7;
        }

        .alert-warning {
            background: #FFF9C4;
            color: #F57F17;
            border: 2px solid #FFF59D;
        }

        .template-section {
            background: linear-gradient(135deg, #E3F2FD 0%, #F3E5F5 100%);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 25px;
            border-left: 5px solid #B39DDB;
            box-shadow: 0 4px 15px rgba(179, 157, 219, 0.1);
        }

        .template-section h3 {
            color: #B39DDB;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .template-section p {
            color: #6D5D7A;
            margin-bottom: 15px;
            line-height: 1.8;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                border-radius: 20px;
            }

            h1 {
                font-size: 1.8em;
            }

            .control-panel {
                grid-template-columns: 1fr;
            }

            .class-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ ì´ˆë“±í•™êµ ë°˜í¸ì„± í”„ë¡œê·¸ë¨</h1>
        <p class="subtitle">í•™ìƒ ëª…ë‹¨ì„ ì…ë ¥í•˜ê³  ê³µì •í•œ ë°˜í¸ì„±ì„ ì§„í–‰í•˜ì„¸ìš”</p>

        <!-- í…œí”Œë¦¿ ì•ˆë‚´ -->
        <div class="template-section">
            <h3>ğŸ“‹ ì‚¬ìš© ë°©ë²•</h3>
            <p>
                <strong>1ë‹¨ê³„:</strong> ì—‘ì…€ íŒŒì¼ì„ ì¤€ë¹„í•˜ì„¸ìš”. (ì—´ ìˆœì„œ: ì´ë¦„, ì„±ë³„, í˜„ì¬ë°˜, ì„±ì , ë¹„ê³ )<br>
                <strong>2ë‹¨ê³„:</strong> í˜„ì¬ í•™ë…„ê³¼ ë‹¤ìŒ í•™ë…„ì„ ì„¤ì •í•˜ì„¸ìš”.<br>
                <strong>3ë‹¨ê³„:</strong> íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”.<br>
                <strong>4ë‹¨ê³„:</strong> ë°˜ ê°œìˆ˜ë¥¼ ì„¤ì •í•˜ê³  'ë°˜í¸ì„± ì‹œì‘' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.<br>
                <strong>5ë‹¨ê³„:</strong> ê²°ê³¼ë¥¼ í™•ì¸í•˜ê³  ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.
            </p>
            <button class="btn-secondary" onclick="downloadTemplate()">ğŸ“¥ ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ</button>
        </div>

        <!-- ì»¨íŠ¸ë¡¤ íŒ¨ë„ -->
        <div class="control-panel">
            <div class="control-group">
                <label for="currentGrade">í˜„ì¬ í•™ë…„</label>
                <input type="number" id="currentGrade" min="1" max="6" value="3" placeholder="ì˜ˆ: 3">
            </div>
            <div class="control-group">
                <label for="nextGrade">ë‹¤ìŒ í•™ë…„</label>
                <input type="number" id="nextGrade" min="1" max="6" value="4" placeholder="ì˜ˆ: 4">
            </div>
            <div class="control-group">
                <label for="classCount">ë°˜ ê°œìˆ˜</label>
                <input type="number" id="classCount" min="1" max="20" value="6" placeholder="ì˜ˆ: 6">
            </div>
            <div class="control-group">
                <label for="fileInput">ğŸ“‚ ì—‘ì…€/CSV íŒŒì¼ ì—…ë¡œë“œ</label>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" onchange="handleFileUpload(event)">
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="btn-primary" onclick="assignClasses()">ğŸ¯ ë°˜í¸ì„± ì‹œì‘</button>
            </div>
            <div class="control-group">
                <label>&nbsp;</label>
                <button class="btn-success" onclick="downloadResult()">ğŸ“¥ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ (ì—‘ì…€)</button>
            </div>
        </div>

        <!-- í†µê³„ íŒ¨ë„ -->
        <div class="stats-panel">
            <div class="stat-card">
                <h3>ì´ í•™ìƒ ìˆ˜</h3>
                <div class="number" id="totalStudents">0</div>
            </div>
            <div class="stat-card">
                <h3>í‰ê·  ì„±ì </h3>
                <div class="number" id="avgScore">0</div>
            </div>
            <div class="stat-card">
                <h3>íŠ¹ì§• í•™ìƒ ìˆ˜</h3>
                <div class="number" id="specialStudents">0</div>
            </div>
        </div>

        <!-- í•™ìƒ ì¶”ê°€ ì„¹ì…˜ -->
        <div class="add-row-section">
            <h3 style="margin-bottom: 15px; color: #667eea;">â• í•™ìƒ ì¶”ê°€</h3>
            <div class="add-row-form">
                <div class="control-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="newName" placeholder="í™ê¸¸ë™">
                </div>
                <div class="control-group">
                    <label>ì„±ë³„</label>
                    <input type="text" id="newGender" placeholder="ë‚¨/ì—¬">
                </div>
                <div class="control-group">
                    <label>í˜„ì¬ ë°˜</label>
                    <input type="text" id="newCurrentClass" placeholder="1ë°˜">
                </div>
                <div class="control-group">
                    <label>ì„±ì  (0-100)</label>
                    <input type="number" id="newScore" min="0" max="100" placeholder="85">
                </div>
                <div class="control-group">
                    <label>ë¹„ê³  (ì„ íƒ)</label>
                    <input type="text" id="newNote" placeholder="íŠ¹ì§• ì…ë ¥">
                </div>
                <div class="control-group">
                    <label>&nbsp;</label>
                    <button class="btn-primary" onclick="addStudent()">ì¶”ê°€</button>
                </div>
            </div>
        </div>

        <!-- í•™ìƒ ëª…ë‹¨ í…Œì´ë¸” -->
        <div class="table-container">
            <table id="studentTable">
                <thead>
                    <tr>
                        <th style="width: 60px;">ë²ˆí˜¸</th>
                        <th style="width: 120px;">ì´ë¦„</th>
                        <th style="width: 80px;">ì„±ë³„</th>
                        <th style="width: 100px;">í˜„ì¬ ë°˜</th>
                        <th style="width: 100px;">ì„±ì </th>
                        <th style="width: 180px;">ë¹„ê³ </th>
                        <th style="width: 150px;">ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody id="studentTableBody">
                    <tr>
                        <td colspan="7" style="padding: 40px; color: #999;">
                            í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ë°˜í¸ì„± ê²°ê³¼ -->
        <div class="result-section" id="resultSection">
            <h2 style="color: #667eea; margin-bottom: 20px;">ğŸ“Š ë°˜í¸ì„± ê²°ê³¼</h2>
            <div id="classGrid" class="class-grid"></div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let students = [];
        let assignmentResult = null;

        // ì—‘ì…€ í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
        function downloadTemplate() {
            const template = [
                ['ì´ë¦„', 'ì„±ë³„', 'í˜„ì¬ë°˜', 'ì„±ì ', 'ë¹„ê³ '],
                ['í™ê¸¸ë™', 'ë‚¨', '1ë°˜', '85', ''],
                ['ê¹€ì˜í¬', 'ì—¬', '1ë°˜', '90', ''],
                ['ì´ì² ìˆ˜', 'ë‚¨', '2ë°˜', '78', 'ë¦¬ë”ì‹­ ê°•í•¨'],
                ['ë°•ë¯¼ìˆ˜', 'ë‚¨', '2ë°˜', '82', ''],
                ['ìµœì§€ìš°', 'ì—¬', '3ë°˜', '88', '']
            ];

            const ws = XLSX.utils.aoa_to_sheet(template);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'í•™ìƒëª…ë‹¨');
            XLSX.writeFile(wb, 'ë°˜í¸ì„±_í…œí”Œë¦¿.xlsx');
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                    // í—¤ë” ì œê±°
                    const rows = jsonData.slice(1);

                    students = rows
                        .filter(row => row[0]) // ì´ë¦„ì´ ìˆëŠ” í–‰ë§Œ
                        .map((row, index) => ({
                            id: Date.now() + index,
                            name: row[0] || '',
                            gender: row[1] || '',
                            currentClass: row[2] || '',
                            score: parseFloat(row[3]) || 0,
                            note: row[4] || ''
                        }));

                    renderTable();
                    updateStats();
                    alert(`${students.length}ëª…ì˜ í•™ìƒ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
                } catch (error) {
                    alert('íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        }

        // í•™ìƒ ì¶”ê°€
        function addStudent() {
            const name = document.getElementById('newName').value.trim();
            const gender = document.getElementById('newGender').value.trim();
            const currentClass = document.getElementById('newCurrentClass').value.trim();
            const score = parseFloat(document.getElementById('newScore').value) || 0;
            const note = document.getElementById('newNote').value.trim();

            if (!name) {
                alert('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            students.push({
                id: Date.now(),
                name,
                gender,
                currentClass,
                score,
                note
            });

            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            document.getElementById('newName').value = '';
            document.getElementById('newGender').value = '';
            document.getElementById('newCurrentClass').value = '';
            document.getElementById('newScore').value = '';
            document.getElementById('newNote').value = '';

            renderTable();
            updateStats();
        }

        // í•™ìƒ ì‚­ì œ
        function deleteStudent(id) {
            if (confirm('ì •ë§ ì´ í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                students = students.filter(s => s.id !== id);
                renderTable();
                updateStats();
            }
        }

        // í•™ìƒ ì •ë³´ ìˆ˜ì •
        function updateStudent(id, field, value) {
            const student = students.find(s => s.id === id);
            if (student) {
                if (field === 'score') {
                    student[field] = parseFloat(value) || 0;
                } else {
                    student[field] = value;
                }
                updateStats();
            }
        }

        // í…Œì´ë¸” ë Œë”ë§
        function renderTable() {
            const tbody = document.getElementById('studentTableBody');

            if (students.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 40px; color: #999;">
                            í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ì—‘ì…€ íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê±°ë‚˜ ì§ì ‘ ì¶”ê°€í•´ì£¼ì„¸ìš”.
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = students.map((student, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <input type="text" value="${student.name}"
                               onchange="updateStudent(${student.id}, 'name', this.value)">
                    </td>
                    <td>
                        <input type="text" value="${student.gender}"
                               onchange="updateStudent(${student.id}, 'gender', this.value)">
                    </td>
                    <td>
                        <input type="text" value="${student.currentClass || ''}"
                               onchange="updateStudent(${student.id}, 'currentClass', this.value)">
                    </td>
                    <td>
                        <input type="number" value="${student.score}" min="0" max="100"
                               onchange="updateStudent(${student.id}, 'score', this.value)">
                    </td>
                    <td>
                        <input type="text" value="${student.note}"
                               onchange="updateStudent(${student.id}, 'note', this.value)">
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-danger" onclick="deleteStudent(${student.id})">ì‚­ì œ</button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats() {
            document.getElementById('totalStudents').textContent = students.length;

            const avgScore = students.length > 0
                ? (students.reduce((sum, s) => sum + s.score, 0) / students.length).toFixed(1)
                : 0;
            document.getElementById('avgScore').textContent = avgScore;

            const specialCount = students.filter(s => s.note && s.note.trim()).length;
            document.getElementById('specialStudents').textContent = specialCount;
        }

        // ë°˜í¸ì„± ì•Œê³ ë¦¬ì¦˜
        function assignClasses() {
            if (students.length === 0) {
                alert('í•™ìƒ ëª…ë‹¨ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const classCount = parseInt(document.getElementById('classCount').value);
            if (!classCount || classCount < 1) {
                alert('ì˜¬ë°”ë¥¸ ë°˜ ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (students.length < classCount) {
                alert('í•™ìƒ ìˆ˜ê°€ ë°˜ ê°œìˆ˜ë³´ë‹¤ ì ìŠµë‹ˆë‹¤.');
                return;
            }

            // ë°˜í¸ì„± ë¡œì§
            const classes = Array.from({ length: classCount }, (_, i) => ({
                name: `${i + 1}ë°˜`,
                students: [],
                totalScore: 0,
                specialCount: 0,
                genderCount: { 'ë‚¨': 0, 'ì—¬': 0 }
            }));

            // ë°°ì¹˜ í—¬í¼ í•¨ìˆ˜
            function addStudentToClass(student, targetClass) {
                targetClass.students.push(student);
                targetClass.totalScore += student.score;
                if (student.note && student.note.trim()) {
                    targetClass.specialCount++;
                }
                if (student.gender === 'ë‚¨' || student.gender === 'ì—¬') {
                    targetClass.genderCount[student.gender]++;
                }
            }

            // Fisher-Yates Shuffle ì•Œê³ ë¦¬ì¦˜ (ì™„ì „ ë¬´ì‘ìœ„ ì„ê¸°)
            function shuffleArray(array) {
                const result = [...array];
                for (let i = result.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [result[i], result[j]] = [result[j], result[i]];
                }
                return result;
            }

            // ì´ì „ ë°˜ ì¶œì‹ ì„ ê· ë“± ë¶„ì‚°ì‹œí‚¤ëŠ” í•¨ìˆ˜
            function distributeByPreviousClass(studentList) {
                // 1. ì´ì „ ë°˜ë³„ë¡œ ê·¸ë£¹í™”
                const grouped = {};
                studentList.forEach(student => {
                    const key = student.currentClass || 'none';
                    if (!grouped[key]) grouped[key] = [];
                    grouped[key].push(student);
                });

                // 2. ê° ì´ì „ ë°˜ ì¶œì‹ ì„ classCountê°œ ê·¸ë£¹ìœ¼ë¡œ ê· ë“± ë¶„ë°°
                const distributedGroups = Array.from({ length: classCount }, () => []);

                Object.values(grouped).forEach(group => {
                    // ë¨¼ì € ì´ ê·¸ë£¹ ë‚´ì—ì„œ ì„ê¸°
                    for (let i = group.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [group[i], group[j]] = [group[j], group[i]];
                    }

                    // ê· ë“± ë¶„ë°°: ê¸°ë³¸ ì¸ì› + ë‚˜ë¨¸ì§€ ëœë¤ ë°°ì¹˜
                    const perGroup = Math.floor(group.length / classCount);
                    const remainder = group.length % classCount;

                    let studentIdx = 0;

                    // ê° ê·¸ë£¹ì— ê¸°ë³¸ ì¸ì› ë¨¼ì € ë°°ì¹˜
                    for (let i = 0; i < classCount; i++) {
                        for (let j = 0; j < perGroup; j++) {
                            if (studentIdx < group.length) {
                                distributedGroups[i].push(group[studentIdx++]);
                            }
                        }
                    }

                    // ë‚˜ë¨¸ì§€ë¥¼ ëœë¤ ìˆœì„œë¡œ ë°°ì¹˜
                    const remainderIndices = [];
                    for (let i = 0; i < classCount; i++) {
                        remainderIndices.push(i);
                    }
                    // Fisher-Yates shuffleë¡œ ìˆœì„œ ì„ê¸°
                    for (let i = remainderIndices.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [remainderIndices[i], remainderIndices[j]] = [remainderIndices[j], remainderIndices[i]];
                    }

                    // ë‚˜ë¨¸ì§€ë¥¼ ëœë¤ ê·¸ë£¹ì— í•˜ë‚˜ì”© ë°°ì¹˜
                    for (let i = 0; i < remainder; i++) {
                        if (studentIdx < group.length) {
                            distributedGroups[remainderIndices[i]].push(group[studentIdx++]);
                        }
                    }
                });

                // 3. ê° ê·¸ë£¹ ë‚´ì—ì„œ ë‹¤ì‹œ í•œ ë²ˆ ì„ê¸° (ë‹¤ë¥¸ ì´ì „ ë°˜ë¼ë¦¬ ì„ì´ë„ë¡)
                distributedGroups.forEach(group => {
                    for (let i = group.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [group[i], group[j]] = [group[j], group[i]];
                    }
                });

                // 4. ëª¨ë“  ê·¸ë£¹ì„ interleave ë°©ì‹ìœ¼ë¡œ í•©ì¹˜ê¸° (Round-Robinê³¼ ì™„ë²½ ë§¤ì¹­)
                const result = [];
                const maxGroupSize = Math.max(...distributedGroups.map(g => g.length));

                for (let i = 0; i < maxGroupSize; i++) {
                    for (let groupIdx = 0; groupIdx < classCount; groupIdx++) {
                        if (i < distributedGroups[groupIdx].length) {
                            result.push(distributedGroups[groupIdx][i]);
                        }
                    }
                }

                return result;
            }

            // í•™ìƒì„ 4ê°œ ê·¸ë£¹ìœ¼ë¡œ ë¶„ë¥˜
            let specialMale = students.filter(s => (s.note && s.note.trim()) && s.gender === 'ë‚¨');
            let specialFemale = students.filter(s => (s.note && s.note.trim()) && s.gender === 'ì—¬');
            let regularMale = students.filter(s => (!s.note || !s.note.trim()) && s.gender === 'ë‚¨');
            let regularFemale = students.filter(s => (!s.note || !s.note.trim()) && s.gender === 'ì—¬');
            let otherStudents = students.filter(s => s.gender !== 'ë‚¨' && s.gender !== 'ì—¬');

            // ê° ê·¸ë£¹ì„ ì„±ì ìˆœìœ¼ë¡œ ì •ë ¬
            specialMale.sort((a, b) => b.score - a.score);
            specialFemale.sort((a, b) => b.score - a.score);
            regularMale.sort((a, b) => b.score - a.score);
            regularFemale.sort((a, b) => b.score - a.score);
            otherStudents.sort((a, b) => b.score - a.score);

            // ê° ê·¸ë£¹ ë‚´ì—ì„œ ì´ì „ ë°˜ ì¶œì‹ ì„ ê· ë“± ë¶„ì‚°
            specialMale = distributeByPreviousClass(specialMale);
            specialFemale = distributeByPreviousClass(specialFemale);
            regularMale = distributeByPreviousClass(regularMale);
            regularFemale = distributeByPreviousClass(regularFemale);
            otherStudents = distributeByPreviousClass(otherStudents);

            // ê° ë°˜ì˜ ëª©í‘œ ë‚¨/ì—¬ í•™ìƒ ìˆ˜ ê³„ì‚°
            const totalMale = specialMale.length + regularMale.length;
            const totalFemale = specialFemale.length + regularFemale.length;
            const totalSpecial = specialMale.length + specialFemale.length;

            const malePerClass = Math.floor(totalMale / classCount);
            const femalePerClass = Math.floor(totalFemale / classCount);
            const specialPerClass = Math.floor(totalSpecial / classCount);

            const maleRemainder = totalMale % classCount;
            const femaleRemainder = totalFemale % classCount;
            const specialRemainder = totalSpecial % classCount;

            // ê° ë°˜ì— ëª©í‘œ ì„¤ì •
            classes.forEach((cls, i) => {
                cls.targetMale = malePerClass + (i < maleRemainder ? 1 : 0);
                cls.targetFemale = femalePerClass + (i < femaleRemainder ? 1 : 0);
                cls.targetSpecial = specialPerClass + (i < specialRemainder ? 1 : 0);
            });

            // ëª©í‘œë¥¼ ì¶©ì¡±í•˜ë©´ì„œ Round-Robin ë°°ì¹˜í•˜ëŠ” í•¨ìˆ˜
            function distributeWithTarget(studentList, checkFunc) {
                let classIdx = 0;
                for (const student of studentList) {
                    let attempts = 0;
                    while (attempts < classCount && !checkFunc(student, classes[classIdx])) {
                        classIdx = (classIdx + 1) % classCount;
                        attempts++;
                    }
                    addStudentToClass(student, classes[classIdx]);
                    classIdx = (classIdx + 1) % classCount;
                }
            }

            // 1. íŠ¹ì§• ë‚¨í•™ìƒ ë°°ì¹˜ (ê° ë°˜ì˜ ë‚¨í•™ìƒ/íŠ¹ì§• í•™ìƒ ëª©í‘œ ê³ ë ¤)
            distributeWithTarget(specialMale, (student, cls) => {
                return cls.genderCount['ë‚¨'] < cls.targetMale && cls.specialCount < cls.targetSpecial;
            });

            // 2. íŠ¹ì§• ì—¬í•™ìƒ ë°°ì¹˜ (ê° ë°˜ì˜ ì—¬í•™ìƒ/íŠ¹ì§• í•™ìƒ ëª©í‘œ ê³ ë ¤)
            distributeWithTarget(specialFemale, (student, cls) => {
                return cls.genderCount['ì—¬'] < cls.targetFemale && cls.specialCount < cls.targetSpecial;
            });

            // 3. ì¼ë°˜ ë‚¨í•™ìƒ ë°°ì¹˜ (ê° ë°˜ì˜ ë‚¨í•™ìƒ ëª©í‘œ ê³ ë ¤)
            distributeWithTarget(regularMale, (student, cls) => {
                return cls.genderCount['ë‚¨'] < cls.targetMale;
            });

            // 4. ì¼ë°˜ ì—¬í•™ìƒ ë°°ì¹˜ (ê° ë°˜ì˜ ì—¬í•™ìƒ ëª©í‘œ ê³ ë ¤)
            distributeWithTarget(regularFemale, (student, cls) => {
                return cls.genderCount['ì—¬'] < cls.targetFemale;
            });

            // 5. ê¸°íƒ€ í•™ìƒ ë°°ì¹˜
            for (let i = 0; i < otherStudents.length; i++) {
                addStudentToClass(otherStudents[i], classes[i % classCount]);
            }

            // ê²°ê³¼ ì €ì¥ ë° í‘œì‹œ
            assignmentResult = classes;
            displayResult(classes);
        }

        // ê²°ê³¼ í‘œì‹œ
        function displayResult(classes) {
            const resultSection = document.getElementById('resultSection');
            const classGrid = document.getElementById('classGrid');
            const currentGrade = document.getElementById('currentGrade').value;
            const nextGrade = document.getElementById('nextGrade').value;

            classGrid.innerHTML = classes.map(classInfo => {
                const avgScore = classInfo.students.length > 0
                    ? (classInfo.totalScore / classInfo.students.length).toFixed(1)
                    : 0;

                return `
                    <div class="class-card">
                        <h3>${nextGrade}í•™ë…„ ${classInfo.name} (${classInfo.students.length}ëª…)</h3>
                        <div class="class-stats">
                            <div><strong>í‰ê·  ì„±ì :</strong> ${avgScore}ì </div>
                            <div><strong>íŠ¹ì§• í•™ìƒ:</strong> ${classInfo.specialCount}ëª…</div>
                            <div><strong>ë‚¨í•™ìƒ:</strong> ${classInfo.genderCount['ë‚¨'] || 0}ëª…</div>
                            <div><strong>ì—¬í•™ìƒ:</strong> ${classInfo.genderCount['ì—¬'] || 0}ëª…</div>
                        </div>
                        <div class="student-list">
                            ${classInfo.students.map((student, idx) => `
                                <div class="student-item">
                                    <div>
                                        <span class="student-name">${idx + 1}. ${student.name}</span>
                                        ${student.currentClass ? `<span style="color: #999; font-size: 0.85em; margin-left: 5px;">(${currentGrade}í•™ë…„ ${student.currentClass})</span>` : ''}
                                        <span class="student-score"> - ${student.score}ì </span>
                                        ${student.note ? `<span class="student-note">ğŸ“Œ ${student.note}</span>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            resultSection.classList.add('show');
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        function downloadResult() {
            if (!assignmentResult || assignmentResult.length === 0) {
                alert('ë¨¼ì € ë°˜í¸ì„±ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.');
                return;
            }

            const currentGrade = document.getElementById('currentGrade').value;
            const nextGrade = document.getElementById('nextGrade').value;
            const wb = XLSX.utils.book_new();

            // ì „ì²´ ê²°ê³¼ ì‹œíŠ¸
            const allData = [[`${currentGrade}í•™ë…„ ë°˜`, `${nextGrade}í•™ë…„ ë°˜`, 'ë²ˆí˜¸', 'ì´ë¦„', 'ì„±ë³„', 'ì„±ì ', 'ë¹„ê³ ']];
            assignmentResult.forEach(classInfo => {
                classInfo.students.forEach((student, idx) => {
                    allData.push([
                        student.currentClass || '',
                        classInfo.name,
                        idx + 1,
                        student.name,
                        student.gender,
                        student.score,
                        student.note
                    ]);
                });
            });
            const wsAll = XLSX.utils.aoa_to_sheet(allData);
            XLSX.utils.book_append_sheet(wb, wsAll, 'ì „ì²´ëª…ë‹¨');

            // ê° ë°˜ë³„ ì‹œíŠ¸
            assignmentResult.forEach(classInfo => {
                const classData = [[`${nextGrade}í•™ë…„ ${classInfo.name}`, '', '', '', '']];
                classData.push([`${currentGrade}í•™ë…„ ë°˜`, 'ë²ˆí˜¸', 'ì´ë¦„', 'ì„±ë³„', 'ì„±ì ', 'ë¹„ê³ ']);
                classInfo.students.forEach((student, idx) => {
                    classData.push([
                        student.currentClass || '',
                        idx + 1,
                        student.name,
                        student.gender,
                        student.score,
                        student.note
                    ]);
                });

                // í†µê³„ ì¶”ê°€
                const avgScore = classInfo.students.length > 0
                    ? (classInfo.totalScore / classInfo.students.length).toFixed(1)
                    : 0;
                classData.push([]);
                classData.push(['í†µê³„']);
                classData.push(['ì´ ì¸ì›', classInfo.students.length]);
                classData.push(['í‰ê·  ì„±ì ', avgScore]);
                classData.push(['íŠ¹ì§• í•™ìƒ', classInfo.specialCount]);
                classData.push(['ë‚¨í•™ìƒ', classInfo.genderCount['ë‚¨'] || 0]);
                classData.push(['ì—¬í•™ìƒ', classInfo.genderCount['ì—¬'] || 0]);

                const ws = XLSX.utils.aoa_to_sheet(classData);
                XLSX.utils.book_append_sheet(wb, ws, `${nextGrade}í•™ë…„ ${classInfo.name}`);
            });

            // í†µê³„ ìš”ì•½ ì‹œíŠ¸
            const statsData = [
                [`${nextGrade}í•™ë…„ ë°˜`, 'ì¸ì›', 'í‰ê·  ì„±ì ', 'íŠ¹ì§• í•™ìƒ', 'ë‚¨í•™ìƒ', 'ì—¬í•™ìƒ']
            ];
            assignmentResult.forEach(classInfo => {
                const avgScore = classInfo.students.length > 0
                    ? (classInfo.totalScore / classInfo.students.length).toFixed(1)
                    : 0;
                statsData.push([
                    classInfo.name,
                    classInfo.students.length,
                    avgScore,
                    classInfo.specialCount,
                    classInfo.genderCount['ë‚¨'] || 0,
                    classInfo.genderCount['ì—¬'] || 0
                ]);
            });
            const wsStats = XLSX.utils.aoa_to_sheet(statsData);
            XLSX.utils.book_append_sheet(wb, wsStats, 'í†µê³„');

            // íŒŒì¼ ì €ì¥
            const today = new Date().toISOString().split('T')[0];
            XLSX.writeFile(wb, `${currentGrade}í•™ë…„to${nextGrade}í•™ë…„_ë°˜í¸ì„±ê²°ê³¼_${today}.xlsx`);
        }

        // ì´ˆê¸°í™”
        updateStats();
    </script>
</body>
</html>
